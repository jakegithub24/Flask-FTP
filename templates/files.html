{% extends "base.html" %}

{% block title %}File Manager{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
{% if breadcrumb and breadcrumb|length > 1 %}
<nav aria-label="breadcrumb" class="mb-4 animate__animated animate__fadeInDown">
    <ol class="breadcrumb bg-dark-blue border border-primary rounded px-3 py-2">
        {% for item in breadcrumb %}
            {% if item.path %}
                <li class="breadcrumb-item">
                    <a href="{{ url_for('file_list', folder_path=item.path) }}" class="text-primary text-decoration-none">
                        <i class="fas fa-folder me-1"></i>{{ item.name }}
                    </a>
                </li>
            {% else %}
                <li class="breadcrumb-item active" aria-current="page">
                    <i class="fas fa-home me-1"></i>{{ item.name }}
                </li>
            {% endif %}
        {% endfor %}
    </ol>
</nav>
{% endif %}

<div class="row mb-4">
    <div class="col">
        <h2 class="animate__animated animate__fadeInLeft">
            <i class="fas fa-folder me-3 text-primary"></i>Storage Directory
        </h2>
        <p class="text-muted animate__animated animate__fadeInRight">
            <i class="fas fa-info-circle me-1"></i>
            Total files: {{ files|length }} • Total folders: {{ folders|length }}
        </p>
    </div>
</div>

<!-- Upload Section -->
<div class="card bg-dark-blue border-primary mb-4 animate__animated animate__fadeInUp">
    <div class="card-header bg-transparent border-primary">
        <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Upload Files</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('upload_file') }}" enctype="multipart/form-data" class="dropzone" id="uploadDropzone">
            <input type="hidden" name="current_path" value="{{ current_path }}">
            <div class="dz-message needsclick">
                <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                <h4>Drop files here or click to upload</h4>
                <span class="text-muted">Max file size: 100MB</span>
            </div>
        </form>
    </div>
</div>

<!-- Create Folder Section -->
<div class="card bg-dark-blue border-primary mb-4 animate__animated animate__fadeInUp">
    <div class="card-body">
        <form method="POST" action="{{ url_for('create_folder') }}" class="row g-3">
            <input type="hidden" name="current_path" value="{{ current_path }}">
            <div class="col-md-8">
                <input type="text" 
                       class="form-control bg-dark border-primary" 
                       name="folder_name" 
                       placeholder="New folder name" 
                       required>
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-folder-plus me-2"></i>Create Folder
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Files List -->
<div class="card bg-dark-blue border-primary animate__animated animate__fadeIn">
    <div class="card-header bg-transparent border-primary d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-file me-2"></i>Files & Folders</h5>
        <span class="badge bg-primary">{{ files|length + folders|length }} items</span>
    </div>
    <div class="card-body p-0">
        {% if files or folders %}
        <div class="table-responsive">
            <table class="table table-dark table-hover mb-0" role="presentation">
                <thead class="bg-dark">
                    <tr>
                        <th><i class="fas fa-file me-2"></i>Name</th>
                        <th><i class="fas fa-ruler-vertical me-2"></i>Size</th>
                        <th><i class="fas fa-calendar me-2"></i>Modified</th>
                        <th><i class="fas fa-cogs me-2"></i>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Folders -->
                    {% for folder in folders %}
                    <tr class="animate__animated animate__fadeIn folder-row" data-folder="{{ folder.path }}">
                        <td>
                            <i class="fas fa-folder text-warning me-2"></i>
                            <strong>{{ folder.name }}</strong>
                        </td>
                        <td class="text-muted">—</td>
                        <td class="text-muted">—</td>
                        <td class="action-buttons">
                            <a href="{{ url_for('file_list', folder_path=folder.path) }}" 
                               class="btn btn-sm btn-outline-info me-2" 
                               title="Open folder">
                                <i class="fas fa-folder-open"></i>
                            </a>
                            <a href="{{ url_for('download_folder', folder_path=folder.path) }}" 
                               class="btn btn-sm btn-outline-success me-2"
                               title="Download as ZIP">
                                <i class="fas fa-download"></i>
                            </a>
                            <a href="{{ url_for('delete_file', file_path=folder.path) }}" 
                               class="btn btn-sm btn-outline-danger"
                               title="Delete folder"
                               onclick="return confirm('Delete this folder and all contents?')">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                    
                    <!-- Files -->
                    {% for file in files %}
                    <tr class="animate__animated animate__fadeIn file-row" data-file="{{ file.path }}">
                        <td>
                            {% set ext = file.name.split('.')[-1].lower() %}
                            {% if ext in ['jpg', 'jpeg', 'png', 'gif'] %}
                                <i class="fas fa-image text-info me-2"></i>
                            {% elif ext in ['pdf'] %}
                                <i class="fas fa-file-pdf text-danger me-2"></i>
                            {% elif ext in ['doc', 'docx'] %}
                                <i class="fas fa-file-word text-primary me-2"></i>
                            {% elif ext in ['xls', 'xlsx'] %}
                                <i class="fas fa-file-excel text-success me-2"></i>
                            {% elif ext in ['zip', 'rar'] %}
                                <i class="fas fa-file-archive text-warning me-2"></i>
                            {% else %}
                                <i class="fas fa-file text-secondary me-2"></i>
                            {% endif %}
                            {{ file.name }}
                        </td>
                        <td>
                            {% if file.size < 1024 %}
                                {{ file.size }} B
                            {% elif file.size < 1048576 %}
                                {{ (file.size / 1024)|round(1) }} KB
                            {% else %}
                                {{ (file.size / 1048576)|round(1) }} MB
                            {% endif %}
                        </td>
                        <td class="text-muted">
                            {{ file.modified }}
                        </td>
                        <td class="action-buttons">
                            <a href="{{ url_for('download_file', file_path=file.path) }}" 
                               class="btn btn-sm btn-outline-success me-2"
                               title="Download file">
                                <i class="fas fa-download"></i>
                            </a>
                            <a href="{{ url_for('delete_file', file_path=file.path) }}" 
                               class="btn btn-sm btn-outline-danger"
                               title="Delete file"
                               onclick="return confirm('Delete this file?')">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-folder-open fa-4x text-muted mb-3"></i>
            <h5 class="text-muted">No files or folders found</h5>
            <p class="text-muted">Upload files or create folders to get started</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Stats -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card bg-dark-blue border-primary text-center animate__animated animate__fadeInUp">
            <div class="card-body">
                <h1 class="display-6 text-primary">{{ files|length }}</h1>
                <p class="text-muted mb-0">Files</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-dark-blue border-primary text-center animate__animated animate__fadeInUp">
            <div class="card-body">
                <h1 class="display-6 text-info">{{ folders|length }}</h1>
                <p class="text-muted mb-0">Folders</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-dark-blue border-primary text-center animate__animated animate__fadeInUp">
            <div class="card-body">
                <h1 class="display-6 text-success" id="storageUsed">0</h1>
                <p class="text-muted mb-0">Storage Used</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js"></script>

<style>
/* Fix for action buttons focus/click glitch */
.action-buttons {
    pointer-events: auto !important;
    cursor: auto !important;
}

.action-buttons .btn {
    pointer-events: auto !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    z-index: 10;
}

.action-buttons .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.action-buttons .btn:focus {
    outline: 2px solid #007bff !important;
    outline-offset: -2px;
}

/* Table row improvement */
tbody tr {
    transition: background-color 0.2s ease;
}

tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1) !important;
}

/* Breadcrumb styling */
.breadcrumb {
    background: linear-gradient(135deg, rgba(25, 51, 102, 0.5) 0%, rgba(0, 123, 255, 0.1) 100%) !important;
}

.breadcrumb-item a {
    transition: all 0.2s ease;
}

.breadcrumb-item a:hover {
    color: #00d4ff !important;
    text-decoration: underline !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Dropzone
    Dropzone.autoDiscover = false;
    
    const dropzone = new Dropzone("#uploadDropzone", {
        url: "{{ url_for('upload_file') }}",
        paramName: "file",
        maxFilesize: 100, // MB
        acceptedFiles: "{% for ext in config.ALLOWED_EXTENSIONS %}.{{ ext }}{% if not loop.last %},{% endif %}{% endfor %}",
        dictDefaultMessage: "Drop files here to upload",
        dictFallbackMessage: "Your browser doesn't support file uploads.",
        dictFileTooBig: "File is too big ({{filesize}}MB). Max filesize: {{maxFilesize}}MB.",
        dictInvalidFileType: "File type not allowed.",
        dictCancelUpload: "Cancel upload",
        dictCancelUploadConfirmation: "Are you sure you want to cancel this upload?",
        dictRemoveFile: "Remove file",
        dictMaxFilesExceeded: "You can only upload one file at a time.",
        init: function() {
            this.on("success", function(file, response) {
                setTimeout(() => {
                    location.reload();
                }, 1500);
            });
            
            this.on("error", function(file, errorMessage) {
                alert("Upload error: " + errorMessage);
            });
        }
    });
    
    // Calculate storage used
    function calculateStorage() {
        let totalSize = 0;
        {% for file in files %}
            totalSize += {{ file.size }};
        {% endfor %}
        
        const storageElement = document.getElementById('storageUsed');
        if (totalSize < 1048576) {
            storageElement.textContent = (totalSize / 1024).toFixed(1) + ' KB';
        } else if (totalSize < 1073741824) {
            storageElement.textContent = (totalSize / 1048576).toFixed(1) + ' MB';
        } else {
            storageElement.textContent = (totalSize / 1073741824).toFixed(1) + ' GB';
        }
    }
    
    calculateStorage();
    
    // Add animation to table rows
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach((row, index) => {
        row.style.animationDelay = `${index * 0.05}s`;
    });
    
    // Prevent event propagation on action buttons
    const actionButtons = document.querySelectorAll('.action-buttons');
    actionButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });
    
    // Make folder rows clickable (for opening folder)
    const folderRows = document.querySelectorAll('.folder-row');
    folderRows.forEach(row => {
        // Don't make the entire row clickable, only the open button
        const openButton = row.querySelector('.btn-outline-info');
        if (openButton) {
            row.style.cursor = 'default';
        }
    });
    
    // Auto-refresh every 30 seconds
    setInterval(() => {
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                console.log('Auto-refreshed at ' + new Date().toLocaleTimeString());
            });
    }, 30000);
});
</script>
{% endblock %}
